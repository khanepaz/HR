<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مرحله ۳: فرم ارزیابی عملکرد</title>
    <!-- Bootstrap 5 CSS - بدون فاصله اضافه -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6f42c1;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --background-light: #f4f7f9;
            --card-bg: #ffffff;
            --text-dark: #34495e;
            --border-color: #e0e6ed;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: var(--background-light);
            padding: 20px 0;
            margin: 0;
            direction: rtl;
        }

        .custom-container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 30px 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            border-bottom: 3px solid var(--primary-color);
            display: inline-block;
            padding-bottom: 10px;
            width: 100%;
        }

        .employee-header {
            background: var(--primary-color);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1em;
            flex-wrap: wrap;
            gap: 10px;
        }

        .employee-header span strong {
            font-weight: bold;
            margin-right: 5px;
        }

        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 0;
        }

        .tab-btn {
            background: var(--background-light);
            border: 1px solid var(--border-color);
            padding: 12px 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: var(--text-dark);
            flex: 1;
            text-align: center;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tab-content {
            padding: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .hidden {
            display: none !important;
        }

        .mbo-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            font-size: 0.9em;
        }

        .mbo-grid > div {
            padding: 8px;
            text-align: center;
        }

        .mbo-grid .header {
            font-weight: bold;
            background: var(--background-light);
            border-radius: 4px;
        }

        .mbo-result-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .mbo-result-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .mbo-item-row:nth-child(even) {
            background: rgba(0, 123, 255, 0.03);
        }

        .bars-slider-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .bars-slider {
            flex-grow: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .bars-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }

        .bars-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
        }

        .bars-score-display {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .section-360 .score-input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-color);
        }

        .section-360 .score-input-group:last-child {
            border-bottom: none;
        }

        .summary-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        .score-breakdown {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--background-light);
        }

        .score-breakdown h3 {
            margin-top: 0;
            color: var(--text-dark);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .score-line {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 1em;
            font-weight: 500;
        }

        .score-line strong {
            color: var(--primary-hover);
        }

        .final-score-box {
            background: var(--success-color);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .final-score-box p {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            font-weight: 500;
        }

        #final-score {
            font-size: 3em;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="custom-container">
        <h1>مرحله ۳: فرم ارزیابی عملکرد پرسنل</h1>

        <div class="employee-header">
            <span id="employee-name"></span>
            <span id="employee-position"></span>
            <span id="employee-unit"></span> <!-- ✅ اضافه شد -->
            <span id="employee-group"></span>
        </div>

        <div class="tab-section">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="openTab('mbo', this)">اهداف کلیدی (MBO)</button>
                <button class="tab-btn" onclick="openTab('bars', this)">صلاحیت‌های رفتاری (BARS)</button>
                <button class="tab-btn" id="tab-360-btn" style="display: none;" onclick="openTab('360', this)">ارزیابی ۳۶۰ درجه</button>
            </div>

            <div class="tab-content" id="tab-mbo">
                <h2 class="mb-3">ارزیابی مبتنی بر اهداف (MBO)</h2>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle">
                        <thead>
                            <tr>
                                <th scope="col">هدف</th>
                                <th scope="col">وزن (%)</th>
                                <th scope="col">واحد</th>
                                <th scope="col">نتیجه کسب شده</th>
                            </tr>
                        </thead>
                        <tbody id="mbo-tbody">
                            <!-- اهداف اینجا به صورت پویا اضافه می‌شوند -->
                        </tbody>
                    </table>
                </div>
                <p class="mt-3 text-muted">**نکته:** در بخش 'نتیجه کسب شده'، عددی را وارد کنید که متناسب با 'واحد' هدف باشد. (مثلاً اگر هدف 'درصد کاهش' است، عدد درصد را وارد کنید).</p>
            </div>

            <div class="tab-content hidden" id="tab-bars">
                <h2 class="mb-3">ارزیابی مبتنی بر صلاحیت‌های رفتاری (BARS)</h2>
                <div id="bars-container">
                </div>
            </div>

            <div class="tab-content hidden" id="tab-360">
                <h2 class="mb-3">ارزیابی ۳۶۰ درجه</h2>
                <div class="section-360">
                    <div class="score-input-group">
                        <span>امتیاز نهایی ارزیابی همکاران (از ۱۰۰)</span>
                        <input type="number" id="score-peers" class="form-control" style="width: 120px;" min="0" max="100" value="0" oninput="calculateFinalScore()">
                    </div>
                    <div class="score-input-group">
                        <span>امتیاز نهایی ارزیابی زیردستان (از ۱۰۰)</span>
                        <input type="number" id="score-subordinates" class="form-control" style="width: 120px;" min="0" max="100" value="0" oninput="calculateFinalScore()">
                    </div>
                    <div class="score-input-group">
                        <span>امتیاز نهایی ارزیابی خودی (از ۱۰۰)</span>
                        <input type="number" id="score-self" class="form-control" style="width: 120px;" min="0" max="100" value="0" oninput="calculateFinalScore()">
                    </div>

                    <div class="score-input-group" style="font-weight: bold; border-top: 2px solid var(--primary-color); padding-top: 15px;">
                        <span>میانگین امتیاز ۳۶۰ درجه</span>
                        <span id="score-360-average" style="color: var(--primary-color);">۰.۰۰</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <div class="row g-4">
                <div class="col-md-7">
                    <div class="score-breakdown">
                        <h3>خلاصه محاسبات امتیاز</h3>
                        <div class="score-line" id="mbo-weight-line">
                            <span>امتیاز نهایی MBO (وزن: ۵۰%):</span>
                            <strong id="mbo-final-score">۰.۰۰</strong>
                        </div>
                        <div class="score-line" id="bars-weight-line">
                            <span>امتیاز نهایی BARS (وزن: ۵۰%):</span>
                            <strong id="bars-final-score">۰.۰۰</strong>
                        </div>
                        <div class="score-line" id="score-360-line" style="display: none;">
                            <span>تأثیر امتیاز ۳۶۰ درجه:</span>
                            <strong id="score-360-impact">۰.۰۰</strong>
                        </div>
                        <hr>
                        <div class="score-line" style="font-size: 1.1em; font-weight: bold;">
                            <span>امتیاز کل (جمع MBO و BARS):</span>
                            <strong id="combined-score">۰.۰۰</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="final-score-box">
                        <p>امتیاز نهایی عملکرد پرسنل (از ۱۰۰)</p>
                        <span id="final-score">۰.۰۰</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-5 pt-3 border-top">
            <button class="btn btn-danger nav-btn px-4" onclick="goBack()">← بازگشت به لیست پرسنل</button>
            <button class="btn btn-secondary nav-btn px-4" onclick="resetForm()">پاک کردن فرم</button>
            <button class="btn btn-success nav-btn px-4" onclick="saveEvaluation()">ذخیره ارزیابی و ادامه ←</button>
        </div>
    </div>

    <!-- Bootstrap JS - بدون فاصله اضافه -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==============================
        // تعریف متغیرهای سراسری
        let selectedEmployee = null;
        let jobTemplate = null;
        let is360Enabled = false;
        let editingIndex = -1;
        let isEditing = false;

        function getGroupName(groupNum) {
            const names = { 1: "عملیاتی/فنی", 2: "کارشناسی/تخصصی", 3: "مدیریتی/کلیدی" };
            return names[groupNum] || "نامشخص";
        }

        // ✅ تابع جدید: محاسبه جمع وزن‌های MBO
        function getTotalMboWeight() {
            if (!jobTemplate || !jobTemplate.mbo) return 50;
            const total = jobTemplate.mbo.reduce((sum, goal) => sum + (goal.weight || 0), 0);
            return Math.min(total, 100); // حداکثر 100%
        }

        function openTab(tabId, button) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        function loadTemplates() {
            let templates = localStorage.getItem('jobTemplates');
            if (!templates) {
                return fetch('templates.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('فایل templates.json یافت نشد.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        localStorage.setItem('jobTemplates', JSON.stringify(data));
                        return data;
                    })
                    .catch(error => {
                        console.warn("⚠️ خطا در بارگذاری templates.json:", error);
                        const emptyTemplate = {};
                        localStorage.setItem('jobTemplates', JSON.stringify(emptyTemplate));
                        return emptyTemplate;
                    });
            } else {
                return Promise.resolve(JSON.parse(templates));
            }
        }

        async function loadData() {
            const empJSON = localStorage.getItem('selectedEmployee');
            if (!empJSON) {
                alert("❌ خطای بارگذاری: پرسنل انتخابی پیدا نشد. به مرحله قبل بازگردید.");
                goBack();
                return;
            }

            selectedEmployee = JSON.parse(empJSON);
            const allTemplates = await loadTemplates();

            const empPosition = (selectedEmployee['سمت'] || '')
                .toString()
                .trim()
                .replace(/\s+/g, ' ')
                .normalize('NFC');

            jobTemplate = allTemplates[empPosition];
            if (!jobTemplate) {
                console.warn(`❌ الگوی ارزیابی برای سمت "${empPosition}" یافت نشد.`);
                alert(`⚠️ الگوی ارزیابی برای سمت "${empPosition}" یافت نشد. از الگوی پیش‌فرض استفاده می‌شود.`);
                jobTemplate = createDefaultTemplate();
            }

            is360Enabled = jobTemplate.enable360 || false;

            document.getElementById('employee-name').innerHTML = `<strong>نام:</strong> ${selectedEmployee['نام و نام خانوادگی']}`;
            document.getElementById('employee-position').innerHTML = `<strong>سمت:</strong> ${empPosition}`;
            // ✅ نمایش "نام واحد یا دپارتمان"
            const unitName = selectedEmployee['نام واحد یا دپارتمان'] || 'بدون واحد';
            document.getElementById('employee-unit').innerHTML = `<strong>واحد:</strong> ${unitName}`;
            document.getElementById('employee-group').innerHTML = `<strong>گروه:</strong> ${getGroupName(jobTemplate.group)}`;

            // ✅ به‌روزرسانی وزن‌ها در UI
            const totalMboWeight = getTotalMboWeight();
            const barsWeight = 100 - totalMboWeight;
            document.getElementById('mbo-weight-line').innerHTML = 
                `<span>امتیاز نهایی MBO (وزن: ${totalMboWeight}%):</span>
                 <strong id="mbo-final-score">۰.۰۰</strong>`;
            document.getElementById('bars-weight-line').innerHTML = 
                `<span>امتیاز نهایی BARS (وزن: ${barsWeight}%):</span>
                 <strong id="bars-final-score">۰.۰۰</strong>`;

            loadPreviousEvaluation();
            buildMBOForm(jobTemplate.mbo);
            buildBARSForm(jobTemplate.bars);

            if (is360Enabled) {
                document.getElementById('tab-360-btn').style.display = 'block';
                document.getElementById('score-360-line').style.display = 'flex';
            }

            calculateFinalScore();
        }

        function createDefaultTemplate() {
            return {
                group: 2,
                mbo: [{ title: "هدف پیش‌فرض ۱", weight: 30, unit: "درصد" }, { title: "هدف پیش‌فرض ۲", weight: 20, unit: "درصد" }],
                bars: [{ title: "صلاحیت پیش‌فرض ۱", scale: 5 }, { title: "صلاحیت پیش‌فرض ۲", scale: 5 }],
                enable360: false
            };
        }

        function loadPreviousEvaluation() {
            const evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
            const empId = selectedEmployee['کد پرسنلی']?.toString().trim();

            editingIndex = evaluations.findIndex(e => e.employeeId === empId);

            if (editingIndex !== -1) {
                isEditing = true;
                const prevEvaluation = evaluations[editingIndex];

                document.querySelector('h1').textContent = "مرحله ۳: ویرایش ارزیابی عملکرد پرسنل";
                document.querySelector('.btn-success').textContent = "به‌روزرسانی ارزیابی";

                if (prevEvaluation.mboScores) {
                    prevEvaluation.mboScores.forEach((score, index) => {
                        const input = document.getElementById(`mbo-result-${index}`);
                        if (input) input.value = score;
                    });
                }

                if (prevEvaluation.barsScores) {
                    prevEvaluation.barsScores.forEach((score, index) => {
                        const slider = document.getElementById(`bars-slider-${index}`);
                        const display = document.getElementById(`bars-score-display-${index}`);
                        if (slider) {
                            slider.value = score;
                            if (display) display.textContent = score;
                        }
                    });
                }

                if (prevEvaluation.score360) {
                    document.getElementById('score-peers').value = prevEvaluation.score360.peers || 0;
                    document.getElementById('score-subordinates').value = prevEvaluation.score360.subordinates || 0;
                    document.getElementById('score-self').value = prevEvaluation.score360.self || 0;
                }
            }
        }

        function buildMBOForm(mboGoals) {
            const tbody = document.getElementById('mbo-tbody');
            tbody.innerHTML = '';

            if (mboGoals.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">هیچ هدفی برای این سمت تعریف نشده است.</td></tr>`;
                return;
            }

            mboGoals.forEach((goal, index) => {
                const row = document.createElement('tr');
                if (index % 2 === 1) {
                    row.classList.add('table-light');
                }

                row.innerHTML = `
                    <td style="text-align: right; font-weight: 500;">${goal.title}</td>
                    <td class="text-center">${goal.weight}%</td>
                    <td class="text-center">${goal.unit || 'عدد'}</td>
                    <td class="text-center">
                        <input type="number" 
                               id="mbo-result-${index}" 
                               class="form-control text-center" 
                               min="0" 
                               value="0" 
                               step="1" 
                               oninput="calculateFinalScore()">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function buildBARSForm(barsCriteria) {
            const container = document.getElementById('bars-container');
            container.innerHTML = '';

            barsCriteria.forEach((criteria, index) => {
                const div = document.createElement('div');
                div.className = 'bars-item';

                div.innerHTML = `
                    <span class="item-title">${criteria.title}</span>
                    <div class="bars-slider-container">
                        <input type="range" 
                               id="bars-slider-${index}" 
                               class="bars-slider" 
                               min="1" 
                               max="${criteria.scale}" 
                               value="1" 
                               step="1" 
                               oninput="updateBarsScore(${index}, this.value)">
                        <span id="bars-score-display-${index}" class="bars-score-display">1</span>
                    </div>
                    <small class="text-muted">امتیازدهی در مقیاس ۱ تا ${criteria.scale} است.</small>
                `;
                container.appendChild(div);
            });
        }

        function updateBarsScore(index, value) {
            document.getElementById(`bars-score-display-${index}`).textContent = value;
            calculateFinalScore();
        }

        // ✅ تابع اصلاح‌شده: محاسبه امتیاز MBO بر اساس وزن واقعی
        function calculateMboScore() {
            const totalMboWeight = getTotalMboWeight();
            let achievedPoints = 0;
            const goals = jobTemplate.mbo || [];

            goals.forEach((goal, index) => {
                const resultInput = document.getElementById(`mbo-result-${index}`);
                const achievedResult = parseFloat(resultInput?.value) || 0;
                const weight = goal.weight || 0;
                const ratio = Math.min(achievedResult, 100) / 100;
                achievedPoints += ratio * weight;
            });

            document.getElementById('mbo-final-score').textContent = achievedPoints.toFixed(2);
            return achievedPoints; // این مقدار مستقیماً در امتیاز نهایی شرکت می‌کند
        }

        // ✅ تابع اصلاح‌شده: محاسبه امتیاز BARS بر اساس وزن باقی‌مانده
        function calculateBarsScore() {
            const totalMboWeight = getTotalMboWeight();
            const barsWeight = 100 - totalMboWeight;

            if (barsWeight <= 0) {
                document.getElementById('bars-final-score').textContent = '0.00';
                return 0;
            }

            let totalBarsScore = 0;
            let maxBarsScore = 0;
            const criteria = jobTemplate.bars || [];

            criteria.forEach((crit, index) => {
                const slider = document.getElementById(`bars-slider-${index}`);
                const score = parseInt(slider?.value) || 0;
                const scale = crit.scale || 1;
                totalBarsScore += score;
                maxBarsScore += scale;
            });

            if (maxBarsScore === 0) {
                document.getElementById('bars-final-score').textContent = '0.00';
                return 0;
            }

            const normalizedPercent = (totalBarsScore / maxBarsScore) * 100;
            const barsContribution = (normalizedPercent / 100) * barsWeight;

            document.getElementById('bars-final-score').textContent = normalizedPercent.toFixed(2);
            return barsContribution;
        }

        function calculate360Average() {
            const peers = parseFloat(document.getElementById('score-peers').value) || 0;
            const subordinates = parseFloat(document.getElementById('score-subordinates').value) || 0;
            const self = parseFloat(document.getElementById('score-self').value) || 0;
            let count = 0;
            let sum = 0;

            if (peers > 0) { sum += peers; count++; }
            if (subordinates > 0) { sum += subordinates; count++; }
            if (self > 0) { sum += self; count++; }

            const average = count > 0 ? (sum / count) : 0;
            document.getElementById('score-360-average').textContent = average.toFixed(2);
            return average;
        }

        function calculateFinalScore() {
            const mboScore = calculateMboScore();
            const barsScore = calculateBarsScore();
            const avg360 = is360Enabled ? calculate360Average() : 0;

            const combined = mboScore + barsScore;
            document.getElementById('combined-score').textContent = combined.toFixed(2);
            document.getElementById('final-score').textContent = combined.toFixed(2);
        }

        function saveEvaluation() {
            try {
                const empId = selectedEmployee['کد پرسنلی']?.toString().trim();
                if (!empId) {
                    alert("❌ خطا: کد پرسنلی نامعتبر است.");
                    return;
                }

                const mboScores = jobTemplate.mbo.map((goal, index) => {
                    return parseFloat(document.getElementById(`mbo-result-${index}`).value) || 0;
                });

                const barsScores = jobTemplate.bars.map((crit, index) => {
                    return parseInt(document.getElementById(`bars-slider-${index}`).value) || 0;
                });

                const evaluation = {
                    employeeId: empId,
                    employeeName: selectedEmployee['نام و نام خانوادگی'],
                    employeePosition: selectedEmployee['سمت'],
                    // ✅ ذخیره "نام واحد یا دپارتمان"
                    employeeUnit: selectedEmployee['نام واحد یا دپارتمان'] || 'بدون واحد',
                    group: jobTemplate.group,
                    template: selectedEmployee['سمت'],
                    mboScores: mboScores,
                    mboFinal: parseFloat(document.getElementById('mbo-final-score').textContent),
                    barsScores: barsScores,
                    barsFinal: parseFloat(document.getElementById('bars-final-score').textContent),
                    score360: is360Enabled ? {
                        peers: parseFloat(document.getElementById('score-peers').value) || 0,
                        subordinates: parseFloat(document.getElementById('score-subordinates').value) || 0,
                        self: parseFloat(document.getElementById('score-self').value) || 0,
                        average: parseFloat(document.getElementById('score-360-average').textContent)
                    } : null,
                    finalScore: parseFloat(document.getElementById('final-score').textContent),
                    date: new Date().toLocaleDateString('fa-IR', { year: 'numeric', month: '2-digit', day: '2-digit' })
                };

                let evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
                let evaluatedEmployees = JSON.parse(localStorage.getItem('evaluatedEmployees') || '{}');

                if (isEditing && editingIndex >= 0) {
                    evaluations[editingIndex] = evaluation;
                    alert("✅ ارزیابی با موفقیت به‌روزرسانی شد!");
                } else {
                    evaluations.push(evaluation);
                    evaluatedEmployees[empId] = true;
                    localStorage.setItem('evaluatedEmployees', JSON.stringify(evaluatedEmployees));
                    alert("✅ ارزیابی با موفقیت ذخیره شد!");
                }

                localStorage.setItem('evaluations', JSON.stringify(evaluations));
                window.location.href = "step2_show_employees_by_position.html";

            } catch (error) {
                console.error("خطا در ذخیره ارزیابی:", error);
                alert("❌ خطایی در ذخیره ارزیابی رخ داد.");
            }
        }

        function resetForm() {
            if (confirm("آیا مطمئنید که می‌خواهید تمام داده‌های فرم فعلی را پاک کنید؟")) {
                window.location.reload();
            }
        }

        function goBack() {
            window.location.href = "step2_show_employees_by_position.html";
        }

        window.onload = () => {
            loadData().catch(console.error);
        };
    </script>
</body>

</html>