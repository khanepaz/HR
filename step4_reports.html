<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø±Ø­Ù„Ù‡ Û´: Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js & XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --secondary-color: #6f42c1;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --background-light: #f4f7f9;
      --card-bg: #ffffff;
      --text-dark: #34495e;
      --border-color: #e0e6ed;
    }

    body {
      font-family: 'Vazirmatn', sans-serif;
      background: var(--background-light);
      padding: 20px 0;
      margin: 0;
      direction: rtl;
    }

    .custom-container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 30px 40px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
      border-bottom: 3px solid var(--primary-color);
      display: inline-block;
      padding-bottom: 10px;
      width: 100%;
    }

    h2 {
      color: var(--text-dark);
      margin-top: 40px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    .stat-card {
      border-right: 5px solid var(--primary-color);
    }
    .stat-card.avg { border-right-color: var(--success-color); }
    .stat-card.count { border-right-color: var(--secondary-color); }

    .stat-title {
      font-size: 1em;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    .stat-value {
      font-size: 2.2em;
      font-weight: bold;
      color: var(--text-dark);
      line-height: 1;
    }
    .stat-card.avg .stat-value { color: var(--success-color); }
    .stat-card.count .stat-value { color: var(--secondary-color); }

    .filter-actions {
      background: rgba(0, 123, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .chart-box {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      height: 400px;
      position: relative;
    }

    .report-table-container {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }

    .report-table .score {
      font-weight: bold;
      text-align: center;
    }
    .report-table .high { color: var(--success-color); }
    .report-table .low { color: var(--danger-color); }
    .report-table .medium { color: var(--warning-color); }
    .report-table .score-360 {
      color: var(--secondary-color);
      font-weight: 500;
    }

    .edit-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .edit-btn:hover {
      background: var(--primary-hover);
    }

    /* Pagination styling */
    .pagination-container {
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <div class="custom-container">
    <h1>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø±Ø³Ù†Ù„</h1>
    
    <div class="row g-4 mb-4">
      <div class="col-md-6 col-lg-3">
        <div class="card stat-card count h-100">
          <div class="card-body">
            <span class="stat-title">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾Ø±Ø³Ù†Ù„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù‡</span>
            <span class="stat-value" id="total-evaluated-count">Û°</span>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card stat-card avg h-100">
          <div class="card-body">
            <span class="stat-title">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ Ø¹Ù…Ù„Ú©Ø±Ø¯ (Ø§Ø² Û±Û°Û°)</span>
            <span class="stat-value" id="average-final-score">Û°.Û°Û°</span>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card stat-card h-100">
          <div class="card-body">
            <span class="stat-title">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² MBO (Ø§Ù‡Ø¯Ø§Ù)</span>
            <span class="stat-value" id="average-mbo-score">Û°.Û°Û°</span>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card stat-card h-100">
          <div class="card-body">
            <span class="stat-title">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø² BARS (Ø±ÙØªØ§Ø±)</span>
            <span class="stat-value" id="average-bars-score">Û°.Û°Û°</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="filter-actions">
      <div class="row g-3 align-items-center">
        <div class="col-md-3">
          <label for="filter-group" class="form-label fw-bold">ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ú¯Ø±ÙˆÙ‡:</label>
          <select id="filter-group" class="form-select" onchange="applyFilters()">
            <option value="all">Ù‡Ù…Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§</option>
            <option value="1">Û± - Ø¹Ù…Ù„ÛŒØ§ØªÛŒ/ÙÙ†ÛŒ</option>
            <option value="2">Û² - Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ/ØªØ®ØµØµÛŒ</option>
            <option value="3">Û³ - Ù…Ø¯ÛŒØ±ÛŒØªÛŒ/Ú©Ù„ÛŒØ¯ÛŒ</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filter-position" class="form-label fw-bold">ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ù…Øª:</label>
          <select id="filter-position" class="form-select" onchange="applyFilters()">
            <option value="all">Ù‡Ù…Ù‡ Ø³Ù…Øªâ€ŒÙ‡Ø§</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="search-input" class="form-label fw-bold">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù…/Ú©Ø¯:</label>
          <input type="search" id="search-input" class="form-control" oninput="applyFilters()" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¬Ø¯ÙˆÙ„...">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <div class="d-grid gap-2">
            <button id="export-excel-btn" class="btn btn-success me-2" onclick="exportExcel()">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ ğŸ“Š</button>
            <button id="export-json-btn" class="btn btn-secondary" onclick="exportJSON()">Ø®Ø±ÙˆØ¬ÛŒ JSON</button>
          </div>
        </div>
      </div>
    </div>
    
    <h2>Ù†Ù…ÙˆØ¯Ø§Ø± Ùˆ ØªÙˆØ²ÛŒØ¹ Ù†Ù…Ø±Ø§Øª</h2>
    <div class="row">
      <div class="col-12">
        <div class="chart-box">
          <canvas id="score-distribution-chart"></canvas>
        </div>
      </div>
    </div>

    <h2>Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</h2>
    <p class="text-muted" style="font-size: 0.95em; margin-top: -15px; margin-bottom: 15px;">
      â„¹ï¸ <strong>Ù†Ú©ØªÙ‡:</strong> Ø§Ù…ØªÛŒØ§Ø² Û³Û¶Û° Ø¯Ø±Ø¬Ù‡ ØµØ±ÙØ§Ù‹ Ø¬Ù‡Øª Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ ØªÙˆØ³Ø¹Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª Ùˆ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡Ù” Ø§Ù…ØªÛŒØ§Ø² Ø±Ø³Ù…ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ ØªØ£Ø«ÛŒØ±ÛŒ Ù†Ø¯Ø§Ø±Ø¯.
    </p>
    <div class="table-responsive report-table-container">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-primary">
          <tr>
            <th>Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th>
            <th>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</th>
            <th>Ø³Ù…Øª</th>
            <th>ÙˆØ§Ø­Ø¯</th>
            <th>Ú¯Ø±ÙˆÙ‡</th>
            <th>Ø§Ù…ØªÛŒØ§Ø² MBO</th>
            <th>Ø§Ù…ØªÛŒØ§Ø² BARS</th>
            <th>Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ</th>
            <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Û³Û¶Û°Â°</th>
            <th>ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ</th>
            <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
          </tr>
        </thead>
        <tbody id="report-table-body">
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <nav aria-label="ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ" class="pagination-container">
      <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>

    <div class="d-flex justify-content-between mt-5 pt-3 border-top">
      <button class="btn btn-danger" onclick="goBack()">â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ù¾Ø±Ø³Ù†Ù„</button>
      <button class="btn btn-success px-4" onclick="forward()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let allEvaluations = [];
    let filteredEvaluations = [];
    let distributionChart = null;
    let currentPage = 1;
    const rowsPerPage = 10;

    function downloadJSON(data, filename = 'evaluation_report.json') {
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function getGroupName(groupNum) {
      const names = { 1: "Ø¹Ù…Ù„ÛŒØ§ØªÛŒ/ÙÙ†ÛŒ", 2: "Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ/ØªØ®ØµØµÛŒ", 3: "Ù…Ø¯ÛŒØ±ÛŒØªÛŒ/Ú©Ù„ÛŒØ¯ÛŒ" };
      return names[groupNum] || "Ù†Ø§Ù…Ø´Ø®Øµ";
    }
    
    function getScoreClass(score) {
      if (score >= 90) return 'high';
      if (score >= 80) return 'medium';
      if (score >= 70) return 'medium';
      if (score < 60) return 'low';
      return '';
    }

    function loadData() {
      const evaluationsJSON = localStorage.getItem('evaluations');
      if (evaluationsJSON) {
        allEvaluations = JSON.parse(evaluationsJSON);
        allEvaluations.forEach(e => {
          e.finalScore = parseFloat(e.finalScore) || 0;
          e.mboFinal = parseFloat(e.mboFinal) || 0;
          e.barsFinal = parseFloat(e.barsFinal) || 0;
        });

        populatePositionFilter();
        applyFilters(); // Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ± Ø§ÙˆÙ„ÛŒÙ‡
      } else {
        document.getElementById('report-table-body').innerHTML = '<tr><td colspan="11" class="text-center text-danger fw-bold">Ù‡ÛŒÚ† Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
        updateStats(0, 0, 0, 0);
        renderPagination(0);
      }
    }

    function populatePositionFilter() {
      const select = document.getElementById('filter-position');
      const positions = new Set(allEvaluations.map(e => e.employeePosition).filter(p => p));
      select.innerHTML = '<option value="all">Ù‡Ù…Ù‡ Ø³Ù…Øªâ€ŒÙ‡Ø§</option>';
      positions.forEach(pos => {
        const option = document.createElement('option');
        option.value = pos;
        option.textContent = pos;
        select.appendChild(option);
      });
    }

    function applyFilters() {
      const groupFilter = document.getElementById('filter-group').value;
      const positionFilter = document.getElementById('filter-position').value;
      const searchInput = document.getElementById('search-input').value.toLowerCase().trim();

      filteredEvaluations = allEvaluations.filter(evaluation => {
        const groupMatch = (groupFilter === 'all' || evaluation.group.toString() === groupFilter);
        const positionMatch = (positionFilter === 'all' || evaluation.employeePosition === positionFilter);
        const searchMatch = !searchInput || 
                            (evaluation.employeeName?.toLowerCase().includes(searchInput)) ||
                            (evaluation.employeeId?.toString().includes(searchInput));
        return groupMatch && positionMatch && searchMatch;
      });

      currentPage = 1;
      renderTable();
    }

    function renderTable() {
      const tableBody = document.getElementById('report-table-body');
      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = startIndex + rowsPerPage;
      const paginatedData = filteredEvaluations.slice(startIndex, endIndex);

      tableBody.innerHTML = '';

      let totalFinalScore = 0;
      let totalMboScore = 0;
      let totalBarsScore = 0;
      
      if (filteredEvaluations.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>';
      } else {
        filteredEvaluations.forEach(eval => {
          totalFinalScore += eval.finalScore;
          totalMboScore += eval.mboFinal;
          totalBarsScore += eval.barsFinal;
        });

        paginatedData.forEach(eval => {
          const unitName = eval.employeeUnit || 'Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø­Ø¯';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${eval.employeeId || '-'}</td>
            <td>${eval.employeeName || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
            <td>${eval.employeePosition || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</td>
            <td>${unitName}</td>
            <td>${getGroupName(eval.group)}</td>
            <td class="score ${getScoreClass(eval.mboFinal)}">${eval.mboFinal.toFixed(2)}</td>
            <td class="score ${getScoreClass(eval.barsFinal)}">${eval.barsFinal.toFixed(2)}</td>
            <td class="score ${getScoreClass(eval.finalScore)}" style="font-size: 1.1em;">${eval.finalScore.toFixed(2)}</td>
            <td class="score score-360">${eval.score360 ? eval.score360.average.toFixed(2) : 'â€”'}</td>
            <td>${eval.date || '-'}</td>
            <td class="text-center">
              <button class="edit-btn" onclick="editEvaluation('${eval.employeeId}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      }

      const count = filteredEvaluations.length;
      const avgFinal = count > 0 ? (totalFinalScore / count) : 0;
      const avgMbo = count > 0 ? (totalMboScore / count) : 0;
      const avgBars = count > 0 ? (totalBarsScore / count) : 0;
      
      updateStats(count, avgFinal, avgMbo, avgBars);
      updateCharts(filteredEvaluations);
      renderPagination(count);
    }

    function renderPagination(totalItems) {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(totalItems / rowsPerPage);
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#">&laquo;</a>`;
      prevLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });
      pagination.appendChild(prevLi);

      // Page numbers (max 5 visible)
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage = i;
          renderTable();
        });
        pagination.appendChild(li);
      }

      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#">&raquo;</a>`;
      nextLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      });
      pagination.appendChild(nextLi);
    }

    function updateStats(count, avgFinal, avgMbo, avgBars) {
      document.getElementById('total-evaluated-count').textContent = count.toLocaleString('fa-IR');
      document.getElementById('average-final-score').textContent = avgFinal.toFixed(2).toLocaleString('fa-IR');
      document.getElementById('average-mbo-score').textContent = avgMbo.toFixed(2).toLocaleString('fa-IR');
      document.getElementById('average-bars-score').textContent = avgBars.toFixed(2).toLocaleString('fa-IR');
    }

    function updateCharts(evaluations) {
      const ctx = document.getElementById('score-distribution-chart').getContext('2d');
      const scoreRanges = [0, 0, 0, 0, 0];
      evaluations.forEach(eval => {
        if (eval.finalScore < 60) scoreRanges[0]++;
        else if (eval.finalScore < 70) scoreRanges[1]++;
        else if (eval.finalScore < 80) scoreRanges[2]++;
        else if (eval.finalScore < 90) scoreRanges[3]++;
        else scoreRanges[4]++;
      });

      if (distributionChart) distributionChart.destroy();

      distributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Ø¶Ø¹ÛŒÙ (<60)', 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ (60-70)', 'Ù…ØªÙˆØ³Ø· (70-80)', 'Ø®ÙˆØ¨ (80-90)', 'Ø¹Ø§Ù„ÛŒ (90-100)'],
          datasets: [{
            label: 'ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø³Ù†Ù„',
            data: scoreRanges,
            backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#27ae60', '#2ecc71'],
            borderRadius: 5,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'ØªÙˆØ²ÛŒØ¹ Ù†Ù…Ø±Ø§Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾Ø±Ø³Ù†Ù„',
              font: { size: 14 }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'ØªØ¹Ø¯Ø§Ø¯' },
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    function exportExcel() {
      if (filteredEvaluations.length === 0) {
        alert("Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
        return;
      }

      const data = filteredEvaluations.map(eval => ({
        'Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ': eval.employeeId,
        'Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ': eval.employeeName,
        'Ø³Ù…Øª': eval.employeePosition,
        'ÙˆØ§Ø­Ø¯': eval.employeeUnit || 'Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø­Ø¯',
        'Ú¯Ø±ÙˆÙ‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ': getGroupName(eval.group),
        'Ø§Ù…ØªÛŒØ§Ø² MBO': eval.mboFinal.toFixed(2),
        'Ø§Ù…ØªÛŒØ§Ø² BARS': eval.barsFinal.toFixed(2),
        'Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ': eval.finalScore.toFixed(2),
        'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Û³Û¶Û° Ø¯Ø±Ø¬Ù‡': eval.score360 ? eval.score360.average.toFixed(2) : 'Ù†Ø¯Ø§Ø±Ø¯',
        'ØªØ§Ø±ÛŒØ® Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ': eval.date
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ");
      XLSX.writeFile(wb, "Ú¯Ø²Ø§Ø±Ø´_Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ_Ø¹Ù…Ù„Ú©Ø±Ø¯.xlsx");
      alert("âœ… ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!");
    }

    function exportJSON() {
      if (filteredEvaluations.length === 0) {
        alert("Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.");
        return;
      }

      const totalScore = filteredEvaluations.reduce((sum, e) => sum + (e.finalScore || 0), 0);
      const unitAverage = (totalScore / filteredEvaluations.length).toFixed(2);

      const exportData = {
        metadata: {
          generatedAt: new Date().toLocaleString('fa-IR'),
          totalEmployees: filteredEvaluations.length,
          unitAverage: parseFloat(unitAverage),
          filters: {
            group: document.getElementById('filter-group').value,
            position: document.getElementById('filter-position').value,
            search: document.getElementById('search-input').value
          }
        },
        evaluations: filteredEvaluations
      };

      const filename = `Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ_ÙˆØ§Ø­Ø¯_${new Date().toLocaleDateString('fa-IR').replace(/\//g, '-')}.json`;
      downloadJSON(exportData, filename);
      alert("âœ… ÙØ§ÛŒÙ„ JSON Ø¨Ø§ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ÙˆØ§Ø­Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!");
    }
    
    function goBack() {
      window.location.href = "step2_show_employees_by_position.html";
    }

    function forward() {
      window.location.href = "index.html";
    }
    
    function editEvaluation(employeeId) {
      const employeeList = JSON.parse(localStorage.getItem('employeeList') || '[]');
      const employeeToEdit = employeeList.find(e => e['Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ']?.toString().trim() === employeeId);
      
      if (employeeToEdit) {
        localStorage.setItem('selectedEmployee', JSON.stringify(employeeToEdit));
        window.location.href = "step3_evaluation_form.html";
      } else {
        alert("âŒ Ù¾Ø±Ø³Ù†Ù„ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù…Ù…Ú©Ù† Ø§Ø³Øª ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ù¾Ø±Ø³Ù†Ù„ Ù…Ø¬Ø¯Ø¯Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.");
      }
    }

    window.onload = loadData;
  </script>
</body>
</html>
